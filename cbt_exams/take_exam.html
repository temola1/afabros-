{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header bg-warning text-dark">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="fas fa-pencil-alt"></i> {{ subject }} Exam</h4>
            <div>
                <span class="badge bg-danger" id="timer">Time: 60:00</span>
            </div>
        </div>
    </div>
    <div class="card-body">
        <form id="examForm">
            {% for question in questions %}
            <div class="question-card mb-4 p-3 border rounded">
                <h5>Question {{ loop.index }}:</h5>
                <p class="lead">{{ question.question_text }}</p>
                
                <div class="options">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="q{{ question.id }}_a" value="A">
                        <label class="form-check-label" for="q{{ question.id }}_a">
                            A) {{ question.option_a }}
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="q{{ question.id }}_b" value="B">
                        <label class="form-check-label" for="q{{ question.id }}_b">
                            B) {{ question.option_b }}
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="q{{ question.id }}_c" value="C">
                        <label class="form-check-label" for="q{{ question.id }}_c">
                            C) {{ question.option_c }}
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="question_{{ question.id }}" id="q{{ question.id }}_d" value="D">
                        <label class="form-check-label" for="q{{ question.id }}_d">
                            D) {{ question.option_d }}
                        </label>
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <div class="text-center mt-4">
                <button type="button" class="btn btn-success btn-lg" onclick="submitExam()">
                    <i class="fas fa-paper-plane"></i> Submit Exam
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let timeLeft = 3600; // 60 minutes in seconds
const timer = document.getElementById('timer');

function updateTimer() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    timer.textContent = `Time: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    if (timeLeft === 0) {
        submitExam();
    } else {
        timeLeft--;
    }
}

function submitExam() {
    const form = document.getElementById('examForm');
    const formData = new FormData(form);
    const answers = {};
    
    for (let [key, value] of formData.entries()) {
        const questionId = key.replace('question_', '');
        answers[questionId] = value;
    }
    
    const data = {
        subject: "{{ subject }}",
        answers: answers,
        time_taken: 3600 - timeLeft
    };
    
    fetch("{{ url_for('submit_exam') }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        window.location.href = "{{ url_for('results') }}";
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error submitting exam. Please try again.');
    });
}

// Update timer every second
setInterval(updateTimer, 1000);
updateTimer(); // Initial call
</script>
{% endblock %}